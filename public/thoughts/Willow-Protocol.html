<!DOCTYPE html>
<html lang="en"><head><title>Willow Protocol</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:title" content="Willow Protocol"/><meta property="og:description" content="Source A protocol for peer-to-peer data stores. We made Willow to make running a network together a sustainable practice. We made Willow to reconcile peer-to-peer networks with social realities."/><meta property="og:image" content="https://wiki.likui.info/static/og-image.png"/><meta property="og:width" content="1200"/><meta property="og:height" content="675"/><link rel="icon" href="../static/icon.png"/><meta name="description" content="Source A protocol for peer-to-peer data stores. We made Willow to make running a network together a sustainable practice. We made Willow to reconcile peer-to-peer networks with social realities."/><meta name="generator" content="Quartz"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link href="../static/font/font-style.css" rel="stylesheet" type="text/css" spa-preserve/><link href="../index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://fonts.googleapis.com/css2?family=JetBrains Mono&amp;family=DM Serif Text:wght@400;700&amp;family=Bricolage Grotesque:ital,wght@0,350;0,600;1,400;1,600&amp;display=swap" rel="stylesheet" type="text/css" spa-preserve/><script src="../prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("../static/contentIndex.json").then(data => data.json())</script></head><body data-slug="thoughts/Willow-Protocol"><div id="texture"></div><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h1 class="page-title"><a href="..">数字花园</a></h1><div class="spacer mobile-only"></div><div class="search"><div id="search-icon"><p>Search</p><div></div><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search</title><desc id="desc">Search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></div><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="search-layout" data-preview="true"></div></div></div></div><div class="darkmode"><input class="toggle" id="darkmode-toggle" type="checkbox" tabindex="-1"/><label id="toggle-label-light" for="darkmode-toggle" tabindex="-1"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg></label><label id="toggle-label-dark" for="darkmode-toggle" tabindex="-1"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></label></div></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="../">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../thoughts/">thoughts</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>Willow Protocol</a></div></nav><h1 class="article-title">Willow Protocol</h1><p class="content-meta">Feb 02, 2024, 4 min read</p><ul class="tags"><li><a href="../tags/seed" class="internal tag-link">#seed</a></li></ul></div></div><article class="popover-hint"><p><a href="https://willowprotocol.org/" class="external alias">Source</a></p>
<p>A protocol for peer-to-peer data stores.</p>
<ul>
<li>We made Willow to make running a network <em>together</em> a sustainable practice.</li>
<li>We made Willow to reconcile peer-to-peer networks with social realities. Wrangling the complexity of distributed systems shouldn’t mean we trade away basic features like deletion, or accept data structures which can only grow without limit.</li>
</ul>
<h3 id="properties">Properties<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#properties" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<ul>
<li>As many of these stores as you want, keyed to different namespaces. When stores from different devices belong to the same namespace, they deterministically sync with each other.</li>
<li>Private and end-to-end encrypted. Other users can’t find out what you’re interested in unless they already know about it themselves.</li>
<li>Total <a href="../thoughts/deletion" class="internal alias" data-slug="thoughts/deletion">delete</a> via prefix pruning (essentially cutting a tree of causal dependencies by trimming down to root and marking that with a single tombstone). Destructive edits. When you update a value, the old values and associated metadata are overwritten.</li>
<li>Fine grained <a href="../thoughts/access-control" class="internal alias" data-slug="thoughts/access-control">access control</a>. Restrict read and write access by semantically meaningful ranges of data, or time range.</li>
<li>Peers can communicate resource budgets, so devices with very limited memory can sync too.</li>
</ul>
<h2 id="data-model">Data Model<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#data-model" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><a href="https://willowprotocol.org/specs/data-model/index.html#data_model" class="external alias">Source</a></p>
<p>Willow is a system for giving meaningful, hierarchical names to arbitrary sequences of bytes (called <em>payloads</em>).</p>
<p>For any given subspace, you can address payloads via paths (e.g. <code>blog/idea/1</code> and <code>blog/idea/2</code>).</p>
<ul>
<li>Entries can be overwritten by more recent entries (Willow tracks timestamps and deletes actually delete everything except the metadata)</li>
<li>Deletes are hierarchical (e.g. deleting <code>blog</code> will delete all of tis subpaths).
<ul>
<li>This is called prefix pruning</li>
</ul>
</li>
</ul>
<p>Entries live in separate subspace owned by different users (intuitively, each user writes to their own, separate universe of data. Willow allows for various ways of controlling who gets to write to which subspace)</p>
<p><img src="../thoughts/images/willow-subspaces.png" width="auto" height="auto" alt/></p>
<p>Interestingly, namespaces can also be aggregated into namespaces.</p>
<p>Some types</p>
<ul>
<li><code>Payload</code>: at most <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> bytes</li>
<li><code>Entry</code>: metadata for a payload
<ul>
<li><code>NamespaceId</code>: keys namespaces</li>
<li><code>SubspaceID</code>: keys subspaces</li>
<li><code>Path</code>: parametrized by
<ul>
<li><code>max_component_length</code>: max length for a path segment</li>
<li><code>max_component_count</code>: max path segments in a path</li>
<li><code>max_path_length</code>: overall limit for size of path</li>
</ul>
</li>
<li><code>Timestamp</code>: time in microseconds since Unix epoch time</li>
<li><code>payload_length</code></li>
<li><code>PayloadDigest</code>: content addressing for a payload
<ul>
<li>calculated from <code>hash_payload(payload) -> hash</code>: maps <code>Payload</code> to <code>PayloadDigest</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>An entry <code>e1</code> is newer than an entry <code>e2</code> if:</p>
<ol>
<li><code>e2.timestamp &lt; e1.timestamp</code> or</li>
<li><code>e2.timestamp == e1.timestamp &amp;&amp; e2.payload_digest &lt; e1.payload_digest</code> or</li>
<li><code>e2.timestamp == e1.timestamp &amp;&amp; e2.payload_digest == e1.payload_digest &amp;&amp; e2.payload_length &lt; e1.payload_length</code></li>
</ol>
<p>Auth:</p>
<ul>
<li><code>AuthorisationToken</code>: proving write permission</li>
<li><code>is_authorized_write(entry, token) -> bool</code>: maps a path and token to whether that token proves a valid permission to write to entry</li>
<li><code>PossiblyAuthorisedEntry</code> is a pair of an <code>Entry</code> and an <code>AuthorisationToken</code></li>
<li><code>AuthorisedEntry</code> is a <code>PossiblyAuthorisedEntry</code> for which <code>is_authorised_write</code> returns true</li>
</ul>
<p>Stores are collection of <code>AuthorisedEntry</code>:</p>
<ul>
<li>All <code>Entry</code> have the same <code>NamespaceId</code></li>
<li>An invariant such that an <code>Entry</code> <code>a</code> cannot both a prefix of another <code>Entry</code> <code>b</code> <em>and</em> <code>a</code> be newer than <code>b</code>
<ul>
<li>That is, updating <code>blog</code> will invalidate <code>blog/abc</code> (is this true?)</li>
</ul>
</li>
</ul>
<p>A join of two stores is obtained by:</p>
<ul>
<li>Start with the union of the two stores</li>
<li>Remove all <code>Entry</code> <code>e1</code> where there is some <code>Entry</code> <code>e2</code> such that
<ol>
<li><code>e2.path</code> is a parent of  <code>e1.path</code> and</li>
<li><code>e2</code> is newer than <code>e1</code></li>
</ol>
</li>
<li>For all <code>Entry</code> with the same <code>SubspaceID</code>, <code>Path</code>, and <code>Timestamp</code>, remove them all except for the one with the greatest <code>PayloadDigest</code></li>
<li>For all <code>Entry</code> with the same <code>SubspaceID</code>, <code>Path</code>, <code>Timestamp</code>, and <code>PayloadDigest</code>, remove them all except for the one with the greatest <code>payload_length</code></li>
</ul>
<p>Stores form a <a href="../thoughts/CRDT#state-based" class="internal alias" data-slug="thoughts/CRDT">state-based CRDT</a> under the join operation.</p>
<h3 id="grouping-entries">Grouping Entries<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#grouping-entries" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p><a href="https://willowprotocol.org/specs/grouping-entries/index.html#grouping_entries" class="external alias">Source</a></p>
<p>An application might want to access all chess games that a certain author played in the past week. This kind of query corresponds to a box in the three-dimensional Willow space.</p>
<p>There are one-dimensional queries called ranges which work along <code>SubspaceId</code>, <code>Path</code>, or <code>Timestamp</code></p>
<p>A <code>3dRange</code> is a 3-tuple of ranges across all three dimensions:</p>
<pre><code>struct 3dRange
  subspaces: SubspaceRange
  paths: PathRange
  times: TimeRange
</code></pre>
<h2 id="sync-protocol">Sync Protocol<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#sync-protocol" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><a href="https://willowprotocol.org/specs/sync/index.html#sync" class="external alias">Source</a></p>
<p>Requirements:</p>
<ul>
<li>Incremental sync: peers can detect regions of shared data with relatively sparse communication to avoid redundant data transfer</li>
<li>Partial sync: peers synchronise only those regions of data they both care about</li>
<li>Private area intersection: peers can discover common interests without disclosing any non-shared information to each other</li>
<li>Resource control: peers communicate (and enforce) their computational resource limits so as not to overload each other</li>
<li>Transport independence</li>
<li>General efficiency: peers can make use of efficient implementation techniques, and the overall bandwidth consumption stays low</li>
</ul></article></div><div class="right sidebar"><div class="graph"><h3>图谱视角</h3><div class="graph-outer"><div id="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:false,&quot;removeTags&quot;:[]}"></div><svg version="1.1" id="global-graph-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
	s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
	c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
	C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
	c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
	v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
	s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
	C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
	S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
	s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
	s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></div><div id="global-graph-outer"><div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:false,&quot;removeTags&quot;:[]}"></div></div></div><div class="backlinks"><h3>反向链接</h3><ul class="overflow"><li>No backlinks found</li></ul></div></div></div><footer class><hr/><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.2.2</a> © 2024</p><ul><li><a href="https://github.com/ilikui">GitHub</a></li><li><a href="https://twitter.com/kico">Twitter</a></li></ul></footer></div></body><script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/copy-tex.min.js" type="application/javascript"></script><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script type="module">
          let mermaidImport = undefined
          document.addEventListener('nav', async () => {
            if (document.querySelector("code.mermaid")) {
              mermaidImport ||= await import('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs')
              const mermaid = mermaidImport.default
              const darkMode = document.documentElement.getAttribute('saved-theme') === 'dark'
              mermaid.initialize({
                startOnLoad: false,
                securityLevel: 'loose',
                theme: darkMode ? 'dark' : 'default'
              })

              await mermaid.run({
                querySelector: '.mermaid'
              })
            }
          });
          </script><script src="../postscript.js" type="module"></script></html>